<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>django-taggit и русские теги - trilandev.com</title>
  <link href="../.././" type="application/atom+xml" rel="alternate" title="trilandev.com ATOM Feed" />
  <link rel="shortcut icon" href="../.././theme/favicon.ico">
  <link rel="stylesheet" href="../.././theme/css/style.css">
  
  
  <script src="../.././theme/js/modernizr-1.6.min.js"></script>
</head>
<body>
  <div id="container">
    <header class="main">
      <nav class="class-for-20px"><span>trilandev.com &rsaquo; <a href="../../.">блог</a></span></nav>
    </header>
    <section class="main">
  <article>
    <header class="clearfix">
      <h1 class="class-for-28px">django-taggit и русские теги</h1>
      <time datetime="2011-02-04T00:00:00" pubdate class="class-for-16px">04 февраля 2011</time>
    </header>
    <p>Существует замечательное приложение <a class="reference external" href="https://github.com/alex/django-taggit">django-taggit</a>, позволяющее быстро и просто
добавить теги к объектам на сайте. Использовать его легче некуда:</p>
<pre class="literal-block">
from django.db import models
from taggit.managers import TaggableManager

class Article(models.Model):
    # ...
    tags = TaggableManager()
</pre>
<p>Но существует небольшая проблема. При сохранении тега приложение генерирует на
основе его имени уникальный код, который удобно использовать в URL.
К сожалению, по-умолчанию из этого кода удаляются все не-ASCII символы, в том
числе и русские. В итоге вместо «мир», «труд», «май» получаем «» (пустая
строка), «_1» и «_2», что не очень хорошо.</p>
<p>Первая мысль — надо форкнуть и пропатчить проект. Но после ознакомления с
<a class="reference external" href="http://django-taggit.readthedocs.org/en/latest/index.html">его документацией</a> и <a class="reference external" href="https://github.com/alex/django-taggit/blob/master/taggit/models.py">кодом</a> оказывается, что все гораздо проще. В Django,
начиная с версии 1.1, можно создавать так называемые прокси-модели.
Прокси-модель — это дочерний от обычной модели класс, в котором  можно изменить
ее поведение, используя при этом ту же самую таблицу базы данных, а значит, те
же самые данные. <a class="reference external" href="http://docs.djangoproject.com/en/1.2/topics/db/models/#proxy-models">Подробнее о прокси-моделях</a></p>
<p>В документации к django-taggit описывается возможность указать с помощью
атрибута <tt class="docutils literal">through</tt> у <tt class="docutils literal">TaggableManager</tt> модель, связывающую объекты с
тегами. В качестве такой модели можно «подсунуть» прокси-модель,
переопределяющую метод класса <tt class="docutils literal">tag_model</tt>, который, в свою очередь возвращает
другую прокси-модель, меняющую способ создания уникального кода тега.</p>
<p>Вот что получилось в итоге:</p>
<pre class="literal-block">
from django.db import models

from taggit.managers import TaggableManager
from taggit.models import Tag, TaggedItem

class ArticleTag(Tag):
    class Meta:
        proxy = True

    def slugify(self, tag, i=None):
        slug = tag.lower().replace(' ', '-')
        if i is not None:
            slug += '-%d' % i
        return slug

class ArticleTaggedItem(TaggedItem):
    class Meta:
        proxy = True

    &#64;classmethod
    def tag_model(cls):
        return ArticleTag

class Article(models.Model):
    # other fields
    tags = TaggableManager(through=ArticleTaggedItem)
</pre>
<p>Этот прием был найден в тестах к приложению, но почему-то не документирован.</p>

    <footer class="clearfix">
      <div class="class-for-16px author">Миша Юматов</div>
      <div class="class-for-16px tags"><a href="../.././tag/django.html">django</a>, <a href="../.././tag/django-taggit.html">django-taggit</a></div>
    </footer>
  </article>
  <div id="comments">
    <h1 class="class-for-24px">Комментарии</h1>
    <div id="disqus_thread"></div>
    <script>
      var disqus_shortname = 'trilandev';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
    <footer class="main">
      <p>Powered by <a href="http://pelican.notmyidea.org/">Pelican</a></p>
    </footer>
  </div>
  <script>
    var _gaq = [['_setAccount', 'UA-9614815-3'], ['_trackPageview']];
    (function(d, t) {
      var g = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      g.async = true;
      g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g, s);
    })(document, 'script');
  </script>
</body>
</html>